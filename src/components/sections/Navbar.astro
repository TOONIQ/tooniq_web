---
import { navigationLinks } from "@utils/navigation";

const currentPath = Astro.url.pathname;

// Call-to-action configuration for the primary button
const primaryCTA = { text: "お問い合わせ", href: "/contact" };

// 現在のページがアクティブかチェック
const isContactPage = currentPath === "/contact";
---

<header
  id="navbar-header"
  class="fixed start-1/2 top-3 z-50 mx-auto flex w-[calc(100%-1rem)] max-w-[400px] -translate-x-1/2 transform flex-wrap rounded-xl border border-slate-300 bg-white/98 backdrop-blur-lg p-2 shadow-2xl transition-all duration-300 sm:max-w-xl sm:p-2.5 md:max-w-3xl md:flex-nowrap md:justify-start lg:max-w-4xl xl:max-w-5xl 2xl:max-w-6xl dark:border-slate-600 dark:bg-slate-900/98"
>
  <nav
    class="relative mx-auto w-full px-2 py-0.5 sm:px-3 lg:px-4 xl:flex xl:items-center xl:justify-between xl:gap-1"
  >
    <div class="flex items-center justify-between gap-x-1">
      <a
        class="flex-none text-base font-black bg-gradient-to-r from-purple-700 via-purple-600 to-indigo-700 bg-clip-text text-transparent focus:opacity-80 focus:outline-hidden sm:text-lg dark:from-purple-400 dark:to-indigo-400 [text-shadow:_0_2px_4px_rgba(147,51,234,0.3)] drop-shadow-md tracking-tight"
        href="/"
        aria-label="TOONIQ Logo"
        translate="no"
        >TOONIQ</a
      >

      <button
        type="button"
        class="hs-collapse-toggle relative flex size-8 items-center justify-center rounded-lg border border-slate-300 bg-white text-[12px] font-medium text-slate-800 shadow-sm hover:bg-slate-50 hover:border-slate-400 focus:bg-slate-50 focus:outline-hidden transition-all dark:border-slate-500 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700 xl:hidden"
        id="hs-header-base-collapse"
        aria-expanded="false"
        aria-controls="hs-header-base"
        aria-label="Toggle navigation"
        data-hs-collapse="#hs-header-base"
      >
        <svg
          class="size-4 hs-collapse-open:hidden"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><line x1="3" x2="21" y1="6" y2="6"></line><line
            x1="3"
            x2="21"
            y1="12"
            y2="12"></line><line x1="3" x2="21" y1="18" y2="18"></line></svg
        >
        <svg
          class="hidden size-4 shrink-0 hs-collapse-open:block"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg
        >
        <span class="sr-only">Toggle navigation</span>
      </button>
    </div>

    <div
      id="hs-header-base"
      class="hs-collapse hidden grow basis-full overflow-hidden transition-all duration-300 xl:ml-4 xl:block"
      aria-labelledby="hs-header-base-collapse"
    >
      <div
        class="max-h-[50vh] overflow-y-auto xl:max-h-none xl:overflow-visible [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-thumb]:bg-slate-300 [&::-webkit-scrollbar-track]:bg-slate-100 [&::-webkit-scrollbar]:w-2"
      >
        <div
          class="flex flex-col gap-0.5 py-1.5 xl:flex-row xl:items-center xl:justify-between xl:gap-1 xl:py-0"
        >
          <div class="grow">
            <div
              class="flex flex-col gap-1 xl:flex-row xl:items-center xl:justify-center xl:gap-1"
            >
              {
                navigationLinks.map((link) => (
                  <a
                    href={link.href}
                    target={link.external ? "_blank" : undefined}
                    rel={link.external ? "noopener noreferrer" : undefined}
                    class={`flex items-center rounded-md px-3 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-slate-900 focus:bg-slate-100 focus:outline-hidden transition-all dark:text-slate-200 dark:hover:bg-slate-700 ${
                      currentPath === link.href
                        ? "!text-white !bg-gradient-to-r from-slate-800 to-slate-900 font-bold shadow-md border border-slate-600"
                        : ""
                    }`}
                    aria-current={
                      currentPath === link.href ? "page" : undefined
                    }
                  >
                    {link.label}
                    {link.external && (
                      <svg
                        class="ml-1 h-4 w-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                        />
                      </svg>
                    )}
                  </a>
                ))
              }
            </div>
          </div>

          <div
            class="mt-3 flex flex-wrap items-center gap-x-1 pb-2 xl:pb-0 xl:ml-2 xl:mt-0"
          >
            <a
              href={primaryCTA.href}
              class={`inline-flex items-center justify-center text-nowrap font-bold px-4 py-2 rounded-md shadow-md transition-all text-sm ${
                isContactPage
                  ? "bg-gradient-to-r from-slate-800 to-slate-900 text-white border border-slate-600 cursor-default"
                  : "bg-gradient-to-r from-teal-500 to-teal-600 text-white hover:from-teal-600 hover:to-teal-700 hover:shadow-lg hover:scale-105"
              }`}
              aria-current={isContactPage ? "page" : undefined}
              >{primaryCTA.text}</a
            >
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  document.addEventListener("astro:page-load", async () => {
    const preline = await import("preline/preline.js");
    preline.HSStaticMethods.autoInit();
    
    // スクロールベースのナビゲーション表示制御
    const navbar = document.getElementById("navbar-header");
    if (!navbar) return;

    let lastScrollY = window.scrollY;
    let hasScrolledDown = false; // 一度でも下にスクロールしたかを記録
    let scrollTimeout: ReturnType<typeof setTimeout>;

    // 初期表示（最初は常に表示）
    navbar.style.top = "0.75rem"; // 初期は表示

    function handleScroll() {
      const currentScrollY = window.scrollY;

      // スクロール方向を検出
      if (currentScrollY > lastScrollY && currentScrollY > 50) {
        // 下にスクロール（50px以上で反応）
        hasScrolledDown = true; // 下スクロールしたことを記録
        if (navbar) navbar.style.top = "-5rem"; // 非表示
      } else if (currentScrollY < lastScrollY && hasScrolledDown) {
        // 上にスクロール（一度下スクロールした後のみ反応）
        if (navbar) navbar.style.top = "0.75rem"; // 表示
      }

      // トップに戻った場合は常に表示
      if (currentScrollY < 50) {
        if (navbar) navbar.style.top = "0.75rem";
      }

      lastScrollY = currentScrollY;
    }

    // スクロールイベントにデバウンスを適用
    function debounceScroll() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(handleScroll, 10);
    }
    
    window.addEventListener("scroll", debounceScroll, { passive: true });
    
    // クリーンアップ
    return () => {
      window.removeEventListener("scroll", debounceScroll);
    };
  });
</script>
